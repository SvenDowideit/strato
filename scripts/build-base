#!/bin/bash
set -e

source $(dirname $0)/version
cd $(dirname $0)/..

BUILD=build
BUILD2=build2
ASSETS=assets

layout_root () {
    mkdir -p $1

    install -m 0755 -d \
      $1/etc \
      $1/etc/ssl \
      $1/home \
      $1/run \
      $1/usr \
      $1/usr/bin \
      $1/usr/sbin \
      $1/usr/share \
      $1/var/cache \
      $1/var/cache/misc \
      $1/var/lib \
      $1/var/lib/misc \
      $1/var/local \
      $1/var/log \
      $1/var/run

    install -m 0555 -d $1/var/empty
    install -m 0700 -d $1/root
    install -m 1777 -d $1/tmp $1/var/tmp

    cp -r ${ASSETS}/certs $1/etc/ssl
    cp ${ASSETS}/group ${ASSETS}/passwd ${ASSETS}/profile ${ASSETS}/shadow $1/etc

    tar -xf ${ASSETS}/${ARCH}/gccbase.tar -C $1
    tar -xf ${ASSETS}/${ARCH}/libgcc.tar -C $1
    tar -xf ${ASSETS}/${ARCH}/libc6.tar -C $1
    rm -rf $1/usr/share/*
}

layout_root ${BUILD}
layout_root ${BUILD2}

./bin/strato add --dir=${BUILD} busybox

cd ${BUILD}
tar -cvf rootfs.tar .
cd -
mv ${BUILD}/rootfs.tar .
rm -rf ${BUILD}

./bin/strato add --dir=${BUILD2} busybox openssl

cd ${BUILD2}
tar -cvf rootfs-min.tar .
cd -
mv ${BUILD2}/rootfs-min.tar .
rm -rf ${BUILD2}

docker build -t strato -f Dockerfile .
docker tag strato strato:${TAG}
docker build -t strato-min -f Dockerfile.min .
docker tag strato-min strato-min:${TAG}

rm rootfs.tar
rm rootfs-min.tar
